<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Header -->
  <header class="admin-header">
    <h2 id="adminGreeting">HELLO Admin</h2>
    <button onclick="logout()">Logout</button>
  </header>

  <!-- Dashboard Content -->
  <main class="dashboard">
    <h1>Admin Dashboard</h1>
    <h1 id="welcomeText" style="display: none;">Hello Admin</h1>

    <!-- Add New Product Form -->
    <section class="add-product">
      <h3>Add New Product</h3>
      <input type="text" id="newProductName" placeholder="Product Name">
      <input type="text" id="newProductImage" placeholder="Image URL">
      <input type="number" id="newProductPrice" placeholder="Price">
      <input type="number" id="newProductStock" placeholder="Stock">
      <button onclick="addProduct()">Add Product</button>
    </section>

    <!-- Products Table -->
    <section class="products-section">
      <h3>All Products</h3>
      <table id="productsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Image</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <!-- Products will be loaded dynamically -->
        </tbody>
      </table>
    </section>
  </main>

  <script>
    // Get stored data
    const token = localStorage.getItem('token');
    const username = localStorage.getItem('username') || 'Admin';

    // Show greeting
    const welcomeText = document.getElementById('welcomeText');
    welcomeText.textContent = `Hello ${username}`;
    welcomeText.style.display = 'block';
    document.getElementById('adminGreeting').textContent = "HELLO " + username.toUpperCase();

    // Fetch all products from backend
    async function fetchProducts() {
      try {
        const res = await fetch('http://localhost:3000/admin/products', {
          headers: { Authorization: 'Bearer ' + token }
        });
        const products = await res.json();
        const tbody = document.querySelector('#productsTable tbody');
        tbody.innerHTML = '';

        products.forEach(p => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${p.product_id}</td>
            <td>${p.name}</td>
            <td><img src="${p.image_url}" alt="${p.name}" style="width:50px; height:50px; object-fit:cover;"></td>
            <td><input type="number" value="${p.price}" id="price-${p.product_id}" /></td>
            <td><input type="number" value="${p.stock}" id="stock-${p.product_id}" /></td>
            <td>
              <button onclick="editProduct(${p.product_id})">Edit</button>
              <button onclick="deleteProduct(${p.product_id})">Delete</button>
            </td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        alert('Failed to fetch products');
        console.error(err);
      }
    }

    // Add new product
    async function addProduct() {
      const name = document.getElementById('newProductName').value;
      const image_url = document.getElementById('newProductImage').value;
      const price = document.getElementById('newProductPrice').value;
      const stock = document.getElementById('newProductStock').value;

      try {
        const res = await fetch('http://localhost:3000/admin/products', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          body: JSON.stringify({ name, image_url, price, stock })
        });
        const data = await res.json();
        alert(data.message);
        fetchProducts();
      } catch (err) {
        alert('Failed to add product');
        console.error(err);
      }
    }

    // Edit product
    async function editProduct(id) {
      const price = document.getElementById(`price-${id}`).value;
      const stock = document.getElementById(`stock-${id}`).value;

      try {
        const res = await fetch(`http://localhost:3000/admin/products/${id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            Authorization: 'Bearer ' + token
          },
          body: JSON.stringify({ price, stock })
        });
        const data = await res.json();
        alert(data.message);
        fetchProducts();
      } catch (err) {
        alert('Failed to update product');
        console.error(err);
      }
    }

    // Delete product
    async function deleteProduct(id) {
      if (!confirm('Are you sure you want to delete this product?')) return;

      try {
        const res = await fetch(`http://localhost:3000/admin/products/${id}`, {
          method: 'DELETE',
          headers: { Authorization: 'Bearer ' + token }
        });
        const data = await res.json();
        alert(data.message);
        fetchProducts();
      } catch (err) {
        alert('Failed to delete product');
        console.error(err);
      }
    }

    // Logout function
    async function logout() {
      try {
        await fetch('http://localhost:3000/logout', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token }
        });
      } catch (err) {
        console.error("Logout failed:", err);
      }
      localStorage.clear();
      window.location.href = 'home.html';
    }

    // Load products on page load
    fetchProducts();
  </script>
</body>
</html>
